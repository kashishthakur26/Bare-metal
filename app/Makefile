###############################################################################
# Project name
###############################################################################

BINARY = firmware

###############################################################################
# Directories
###############################################################################

SRC_DIR        = src
INC_DIR        = inc
OPENCM3_DIR    = ../libopencm3

###############################################################################
# Toolchain
###############################################################################

PREFIX  = arm-none-eabi

CC      = $(PREFIX)-gcc
LD      = $(PREFIX)-gcc
OBJCOPY = $(PREFIX)-objcopy
OBJDUMP = $(PREFIX)-objdump
SIZE    = $(PREFIX)-size

###############################################################################
# MCU Configuration (STM32F4 Cortex-M4 with FPU)
###############################################################################

CPU = cortex-m4

ARCH_FLAGS = -mcpu=$(CPU) -mthumb
FPU_FLAGS  = -mfloat-abi=hard -mfpu=fpv4-sp-d16

###############################################################################
# Compiler Flags
###############################################################################

CFLAGS  = $(ARCH_FLAGS) $(FPU_FLAGS)
CFLAGS += -O0 -g
CFLAGS += -DSTM32F4
CFLAGS += -Wall -Wextra
CFLAGS += -ffunction-sections -fdata-sections

###############################################################################
# Include paths
###############################################################################

CFLAGS += -I$(INC_DIR)
CFLAGS += -I$(OPENCM3_DIR)/include

###############################################################################
# Linker Configuration
###############################################################################

LDSCRIPT = linkerscript.ld

LDFLAGS  = $(ARCH_FLAGS) $(FPU_FLAGS)
LDFLAGS += -T$(LDSCRIPT)
LDFLAGS += -L$(OPENCM3_DIR)/lib
LDFLAGS += -lopencm3_stm32f4
LDFLAGS += -nostartfiles
LDFLAGS += -Wl,--gc-sections

###############################################################################
# Source files
###############################################################################

SRCS = $(SRC_DIR)/firmware.c

###############################################################################
# Object files
###############################################################################

OBJS = $(SRCS:.c=.o)

###############################################################################
# Build targets
###############################################################################

all: $(BINARY).elf $(BINARY).bin

###############################################################################
# ELF generation
###############################################################################

$(BINARY).elf: $(OBJS)
	$(LD) $(OBJS) $(LDFLAGS) -o $@
	$(SIZE) $@

###############################################################################
# BIN generation
###############################################################################

$(BINARY).bin: $(BINARY).elf
	$(OBJCOPY) -Obinary $< $@

###############################################################################
# Compile source files
###############################################################################

%.o: %.c
	$(CC) $(CFLAGS) -c $< -o $@

###############################################################################
# Clean build files
###############################################################################

clean:
	rm -f $(SRC_DIR)/*.o *.elf *.bin

###############################################################################
# Phony targets
###############################################################################

.PHONY: all clean
